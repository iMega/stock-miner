package yahooprovider

import (
	"bytes"
	"context"
	"io/ioutil"
	"net/http"
	"reflect"
	"testing"

	"github.com/imega/stock-miner/domain"
	"github.com/imega/stock-miner/httpwareclient"
)

func Test_pricer_Range(t *testing.T) {
	type fields struct {
		URL string
	}
	type args struct {
		ctx context.Context
		s   domain.StockItem
	}
	tests := []struct {
		name    string
		fields  fields
		args    args
		mock    *httpwareclient.HTTPClientMock
		want    domain.StockItemRange
		wantErr bool
	}{
		{
			name: "optimistic",
			args: args{
				ctx: context.Background(),
				s:   domain.StockItem{Ticker: "AAPL"},
			},
			mock: &httpwareclient.HTTPClientMock{Func: optimisticMock},
			want: domain.StockItemRange{
				High: 150,
				Low:  122.25,
			},
			wantErr: false,
		},
		{
			name: "returns error in response",
			args: args{
				ctx: context.Background(),
				s:   domain.StockItem{Ticker: "AAPL"},
			},
			mock:    &httpwareclient.HTTPClientMock{Func: errorResponseMock},
			want:    domain.StockItemRange{},
			wantErr: true,
		},
		{
			name: "returns empty result",
			args: args{
				ctx: context.Background(),
				s:   domain.StockItem{Ticker: "AAPL"},
			},
			mock:    &httpwareclient.HTTPClientMock{Func: emptyResultMock},
			want:    domain.StockItemRange{},
			wantErr: true,
		},
	}
	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			httpwareclient.WithClient(tt.mock)
			p := &pricer{
				URL: tt.fields.URL,
			}
			got, err := p.Range(tt.args.ctx, tt.args.s)
			if (err != nil) != tt.wantErr {
				t.Errorf("pricer.Range() error = %v, wantErr %v", err, tt.wantErr)
				return
			}
			if !reflect.DeepEqual(got, tt.want) {
				t.Errorf("pricer.Range() = %v, want %v", got, tt.want)
			}
		})
	}
}

func optimisticMock(req *http.Request) (*http.Response, error) {
	b := []byte(`
    {
        "chart" : {
           "error" : null,
           "result" : [
              {
                 "indicators" : {
                    "adjclose" : [
                       {
                          "adjclose" : [
                             134.162109375,
                             133.353485107422,
                             133.253662109375,
                             131.237091064453,
                             132.315246582031,
                             127.633201599121,
                             127.882789611816,
                             129.520004272461,
                             130.210006713867,
                             126.849998474121,
                             125.910003662109,
                             122.769996643066,
                             124.970001220703,
                             127.449996948242,
                             126.269996643066,
                             124.849998474121,
                             124.690002441406,
                             127.309997558594,
                             125.430000305176,
                             127.099998474121,
                             126.900001525879,
                             126.849998474121,
                             125.279998779297,
                             124.610000610352,
                             124.279998779297,
                             125.059997558594,
                             123.540000915527,
                             125.889999389648,
                             125.900001525879,
                             126.73999786377,
                             127.129997253418,
                             126.110000610352,
                             127.349998474121,
                             130.479995727539,
                             129.639999389648,
                             130.149993896484,
                             131.789993286133,
                             130.460006713867,
                             132.300003051758,
                             133.979995727539,
                             133.699996948242,
                             133.410003662109,
                             133.110000610352,
                             134.779998779297,
                             136.330001831055,
                             136.960006713867,
                             137.270004272461,
                             139.960006713867,
                             142.020004272461,
                             144.570007324219,
                             143.240005493164,
                             145.110000610352,
                             144.5,
                             145.639999389648,
                             149.149993896484,
                             148.479995727539,
                             146.389999389648
                          ]
                       }
                    ],
                    "quote" : [
                       {
                          "close" : [
                             134.389999389648,
                             133.580001831055,
                             133.479995727539,
                             131.460006713867,
                             132.539993286133,
                             127.849998474121,
                             128.100006103516,
                             129.740005493164,
                             130.210006713867,
                             126.849998474121,
                             125.910003662109,
                             122.769996643066,
                             124.970001220703,
                             127.449996948242,
                             126.269996643066,
                             124.849998474121,
                             124.690002441406,
                             127.309997558594,
                             125.430000305176,
                             127.099998474121,
                             126.900001525879,
                             126.849998474121,
                             125.279998779297,
                             124.610000610352,
                             124.279998779297,
                             125.059997558594,
                             123.540000915527,
                             125.889999389648,
                             125.900001525879,
                             126.73999786377,
                             127.129997253418,
                             126.110000610352,
                             127.349998474121,
                             130.479995727539,
                             129.639999389648,
                             130.149993896484,
                             131.789993286133,
                             130.460006713867,
                             132.300003051758,
                             133.979995727539,
                             133.699996948242,
                             133.410003662109,
                             133.110000610352,
                             134.779998779297,
                             136.330001831055,
                             136.960006713867,
                             137.270004272461,
                             139.960006713867,
                             142.020004272461,
                             144.570007324219,
                             143.240005493164,
                             145.110000610352,
                             144.5,
                             145.639999389648,
                             149.149993896484,
                             148.479995727539,
                             146.389999389648
                          ],
                          "high" : [
                             135.410003662109,
                             135.020004272461,
                             137.070007324219,
                             133.559997558594,
                             134.070007324219,
                             131.490005493164,
                             130.449996948242,
                             129.75,
                             131.259994506836,
                             129.539993286133,
                             126.269996643066,
                             124.639999389648,
                             126.150001525879,
                             127.889999389648,
                             126.930000305176,
                             126.98999786377,
                             124.919998168945,
                             127.720001220703,
                             128,
                             127.940002441406,
                             128.320007324219,
                             127.389999389648,
                             127.639999389648,
                             125.800003051758,
                             125.349998474121,
                             125.23999786377,
                             124.849998474121,
                             126.160003662109,
                             126.319999694824,
                             128.460006713867,
                             127.75,
                             128.190002441406,
                             127.440002441406,
                             130.539993286133,
                             130.600006103516,
                             130.889999389648,
                             132.550003051758,
                             131.509994506836,
                             132.410003662109,
                             134.080001831055,
                             134.320007324219,
                             134.639999389648,
                             133.889999389648,
                             135.25,
                             136.490005493164,
                             137.410003662109,
                             137.330001831055,
                             140,
                             143.149993896484,
                             144.889999389648,
                             144.059997558594,
                             145.649993896484,
                             146.320007324219,
                             147.460006713867,
                             149.570007324219,
                             150,
                             149.759994506836
                          ],
                          "low" : [
                             134.110000610352,
                             133.080001831055,
                             132.449996948242,
                             131.070007324219,
                             131.830001831055,
                             126.699996948242,
                             127.970001220703,
                             127.129997253418,
                             129.479995727539,
                             126.809997558594,
                             122.769996643066,
                             122.25,
                             124.26000213623,
                             125.849998474121,
                             125.169998168945,
                             124.779998779297,
                             122.860000610352,
                             125.099998474121,
                             125.209999084473,
                             125.940002441406,
                             126.319999694824,
                             126.419998168945,
                             125.080001831055,
                             124.550003051758,
                             123.940002441406,
                             124.050003051758,
                             123.129997253418,
                             123.849998474121,
                             124.830001831055,
                             126.209999084473,
                             126.519996643066,
                             125.940002441406,
                             126.099998474121,
                             127.069999694824,
                             129.389999389648,
                             128.460006713867,
                             129.649993896484,
                             130.240005493164,
                             129.210006713867,
                             131.619995117188,
                             133.229995727539,
                             132.929992675781,
                             132.809997558594,
                             133.350006103516,
                             134.350006103516,
                             135.869995117188,
                             135.759994506836,
                             137.75,
                             140.070007324219,
                             142.660003662109,
                             140.669998168945,
                             142.649993896484,
                             144,
                             143.630004882812,
                             147.679992675781,
                             147.089996337891,
                             145.880004882812
                          ],
                          "open" : [
                             135.009994506836,
                             134.309997558594,
                             136.470001220703,
                             131.779998779297,
                             132.039993286133,
                             131.190002441406,
                             129.199996948242,
                             127.889999389648,
                             130.850006103516,
                             129.410003662109,
                             123.5,
                             123.400001525879,
                             124.580001831055,
                             126.25,
                             126.819999694824,
                             126.559997558594,
                             123.160003662109,
                             125.230003356934,
                             127.819999694824,
                             126.01000213623,
                             127.819999694824,
                             126.959999084473,
                             126.440002441406,
                             125.569999694824,
                             125.080001831055,
                             124.279998779297,
                             124.680000305176,
                             124.069999694824,
                             126.169998168945,
                             126.599998474121,
                             127.209999084473,
                             127.019996643066,
                             126.529998779297,
                             127.819999694824,
                             129.940002441406,
                             130.369995117188,
                             129.800003051758,
                             130.710006713867,
                             130.300003051758,
                             132.130004882812,
                             133.770004272461,
                             134.449996948242,
                             133.460006713867,
                             133.410003662109,
                             134.800003051758,
                             136.169998168945,
                             136.600006103516,
                             137.899993896484,
                             140.070007324219,
                             143.539993286133,
                             141.580001831055,
                             142.75,
                             146.210006713867,
                             144.029998779297,
                             148.100006103516,
                             149.240005493164,
                             148.460006713867
                          ],
                          "volume" : [
                             66015800,
                             107760100,
                             151101000,
                             109839500,
                             75135100,
                             137564700,
                             84000900,
                             78128300,
                             78973300,
                             88071200,
                             126142800,
                             112172300,
                             105861300,
                             81918000,
                             74244600,
                             63342900,
                             92612000,
                             76857100,
                             79295400,
                             63092900,
                             72009500,
                             56575900,
                             94625600,
                             71311100,
                             67637100,
                             59278900,
                             76229200,
                             75169300,
                             71057600,
                             74403800,
                             56877900,
                             71186400,
                             53522400,
                             96906500,
                             62746300,
                             91815000,
                             96721700,
                             108953300,
                             79663300,
                             74783600,
                             60214200,
                             68711000,
                             70783700,
                             62111300,
                             64556100,
                             63261400,
                             52485800,
                             78852600,
                             108181800,
                             104911600,
                             105575500,
                             99788400,
                             76299700,
                             100827100,
                             127050800,
                             106820300,
                             93100300
                          ]
                       }
                    ]
                 },
                 "meta" : {
                    "chartPreviousClose" : 134.72,
                    "currency" : "USD",
                    "currentTradingPeriod" : {
                       "post" : {
                          "end" : 1626739200,
                          "gmtoffset" : -14400,
                          "start" : 1626724800,
                          "timezone" : "EDT"
                       },
                       "pre" : {
                          "end" : 1626701400,
                          "gmtoffset" : -14400,
                          "start" : 1626681600,
                          "timezone" : "EDT"
                       },
                       "regular" : {
                          "end" : 1626724800,
                          "gmtoffset" : -14400,
                          "start" : 1626701400,
                          "timezone" : "EDT"
                       }
                    },
                    "dataGranularity" : "1d",
                    "exchangeName" : "NMS",
                    "exchangeTimezoneName" : "America/New_York",
                    "firstTradeDate" : 345479400,
                    "gmtoffset" : -14400,
                    "instrumentType" : "EQUITY",
                    "priceHint" : 2,
                    "range" : "",
                    "regularMarketPrice" : 146.39,
                    "regularMarketTime" : 1626465602,
                    "symbol" : "AAPL",
                    "timezone" : "EDT",
                    "validRanges" : [
                       "1d",
                       "5d",
                       "1mo",
                       "3mo",
                       "6mo",
                       "1y",
                       "2y",
                       "5y",
                       "10y",
                       "ytd",
                       "max"
                    ]
                 },
                 "timestamp" : [
                    1619530200,
                    1619616600,
                    1619703000,
                    1619789400,
                    1620048600,
                    1620135000,
                    1620221400,
                    1620307800,
                    1620394200,
                    1620653400,
                    1620739800,
                    1620826200,
                    1620912600,
                    1620999000,
                    1621258200,
                    1621344600,
                    1621431000,
                    1621517400,
                    1621603800,
                    1621863000,
                    1621949400,
                    1622035800,
                    1622122200,
                    1622208600,
                    1622554200,
                    1622640600,
                    1622727000,
                    1622813400,
                    1623072600,
                    1623159000,
                    1623245400,
                    1623331800,
                    1623418200,
                    1623677400,
                    1623763800,
                    1623850200,
                    1623936600,
                    1624023000,
                    1624282200,
                    1624368600,
                    1624455000,
                    1624541400,
                    1624627800,
                    1624887000,
                    1624973400,
                    1625059800,
                    1625146200,
                    1625232600,
                    1625578200,
                    1625664600,
                    1625751000,
                    1625837400,
                    1626096600,
                    1626183000,
                    1626269400,
                    1626355800,
                    1626442200
                 ]
              }
           ]
        }
     }
    `)
	buffer := bytes.NewBuffer(b)

	return &http.Response{Body: ioutil.NopCloser(buffer)}, nil
}

func errorResponseMock(req *http.Request) (*http.Response, error) {
	b := []byte(`
    {
        "chart" : {
           "error" : {
              "code" : "Bad Request",
              "description" : "Invalid input - interval=1 is not supported. Valid intervals: [1m, 2m, 5m, 15m, 30m, 60m, 90m, 1h, 1d, 5d, 1wk, 1mo, 3mo]"
           },
           "result" : null
        }
     }
    `)

	buffer := bytes.NewBuffer(b)

	return &http.Response{Body: ioutil.NopCloser(buffer)}, nil
}

func emptyResultMock(req *http.Request) (*http.Response, error) {
	b := []byte(`
    {
        "chart" : {
           "error" : null,
           "result" : []
        }
    }
    `)
	buffer := bytes.NewBuffer(b)

	return &http.Response{Body: ioutil.NopCloser(buffer)}, nil
}
